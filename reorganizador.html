<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reorganizador de Cards</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        body { background: #0d0d0d; color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; color: #f0c000; }
        .container { background: #181818; padding: 2rem; border-radius: 1rem; width: 100%; max-width: 800px; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        button { background: linear-gradient(90deg, #f0c000, #d4a700); color: #000; border: none; padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; margin: 0.5rem 0; }
        button:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(240, 192, 0, 0.6); }

        #cardList { list-style: none; margin-top: 1.5rem; border-top: 1px solid #333; padding-top: 1rem; }
        .card-item { display: flex; align-items: center; background: #222; padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; cursor: move; border-left: 5px solid #444; }
        .card-item:hover { background: #282828; border-left-color: #f0c000; }
        .card-item.dragging { opacity: 0.5; }
        .card-info { flex-grow: 1; margin-left: 15px; }
        .card-info h3 { font-size: 1.1rem; color: #f0c000; }
        .card-info p { font-size: 0.85rem; color: #ccc; }
        .card-preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }

        .notificacao { position: fixed; bottom: 30px; right: 30px; background: #25D366; color: #000; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; box-shadow: 0 0 20px rgba(37, 211, 102, 0.6); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 999; }
        .notificacao.mostrar { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <h1>Reorganizador de Cards ‚ÜïÔ∏è</h1>

    <div class="container">
        <button id="carregarIndexBtn">1. Selecionar/Carregar index.html</button>
        <p id="status" style="color: #f0c000; margin-top: 1rem;">Aguardando o carregamento do arquivo...</p>

        <ul id="cardList">
            </ul>
        
        <button id="salvarAlteracoesBtn" style="display:none; background: #007bff; color: #fff;">2. Salvar Nova Ordem no index.html</button>
    </div>

    <div id="notificacao" class="notificacao"></div>

    <script>
        let indexFileHandle = null;
        let originalContent = '';
        let extractedCards = [];
        let galeriaContentStart = -1;
        let galeriaContentEnd = -1;
        let draggedItem = null;

        const cardList = document.getElementById('cardList');
        const statusEl = document.getElementById('status');
        const salvarAlteracoesBtn = document.getElementById('salvarAlteracoesBtn');
        const carregarIndexBtn = document.getElementById('carregarIndexBtn');

        function mostrarNotificacao(mensagem, sucesso = true) {
            const notificacao = document.getElementById('notificacao');
            notificacao.textContent = mensagem;
            notificacao.style.background = sucesso ? '#25D366' : '#dc3545';
            notificacao.classList.add('mostrar');
            setTimeout(() => notificacao.classList.remove('mostrar'), 3000);
        }

        function extrairCards(htmlContent) {
            const galeriaSectionRegex = /<section class="galeria">([\s\S]*?)<\/section>/;
            const match = htmlContent.match(galeriaSectionRegex);
            if (!match) {
                mostrarNotificacao("‚ùå N√£o foi poss√≠vel encontrar a <section class='galeria'>.", false);
                return [];
            }
            const galeriaContent = match[1];
            const galeriaStart = htmlContent.indexOf('<section class="galeria">');
            galeriaContentStart = galeriaStart + '<section class="galeria">'.length;
            galeriaContentEnd = galeriaContentStart + galeriaContent.length;

            const cardRegex = /(<div\s+class="item"[\s\S]*?<\/div>\s*<\/div>)/g;
            const cardMatches = [...galeriaContent.matchAll(cardRegex)];
            return cardMatches.map(m => m[0].trim());
        }

        function parseCardData(cardHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHtml;
            const card = tempDiv.querySelector('.item');
            if (!card) return null;
            const button = card.querySelector('button.open-modal-btn');
            const img = card.querySelector('img');
            return {
                html: cardHtml,
                nome: button ? button.getAttribute('data-name') : 'Nome Desconhecido',
                id: button ? button.getAttribute('data-id') : 'ID Desconhecido',
                image: img ? img.src : ''
            };
        }

        function renderCardList() {
            cardList.innerHTML = '';
            if (extractedCards.length === 0) {
                statusEl.textContent = "Nenhum card encontrado na galeria.";
                return;
            }

            statusEl.textContent = `Total de ${extractedCards.length} cards encontrados. Arraste para reordenar.`;

            extractedCards.forEach((cardHtml, index) => {
                const cardData = parseCardData(cardHtml);
                const listItem = document.createElement('li');
                listItem.className = 'card-item';
                listItem.draggable = true; // Torna arrast√°vel
                listItem.dataset.index = index;
                listItem.innerHTML = `
                    <img src="${cardData.image}" alt="${cardData.nome}" class="card-preview-img">
                    <div class="card-info">
                        <h3>${cardData.nome}</h3>
                        <p>ID: ${cardData.id}</p>
                    </div>
                `;
                cardList.appendChild(listItem);
            });

            addDragListeners();
            salvarAlteracoesBtn.style.display = 'block';
        }

        async function carregarIndexHtml() {
            try {
                const [handle] = await window.showOpenFilePicker({ types: [{ description: "HTML Files (index.html)", accept: { "text/html": [".html"] } }] });
                indexFileHandle = handle;
                const file = await indexFileHandle.getFile();
                originalContent = await file.text();
                extractedCards = extrairCards(originalContent);
                renderCardList();
                mostrarNotificacao("‚úÖ index.html carregado e pronto para reordena√ß√£o!");
            } catch (err) {
                console.error("Erro ao carregar ou a√ß√£o cancelada:", err);
                mostrarNotificacao("‚ö†Ô∏è A√ß√£o cancelada ou erro ao carregar o arquivo.", false);
            }
        }

        async function salvarAlteracoes() {
            if (!indexFileHandle || extractedCards.length === 0) {
                mostrarNotificacao("‚ùå Nenhum arquivo carregado ou cards para salvar.", false);
                return;
            }

            // 1. O array extractedCards j√° est√° na nova ordem (gra√ßas √† fun√ß√£o handleDrop)
            const novoConteudoGaleria = "\n" + extractedCards.join("\n") + "\n";
            
            // 2. Constr√≥i o novo conte√∫do completo
            const novoConteudoCompleto = 
                originalContent.slice(0, galeriaContentStart) +
                novoConteudoGaleria +
                originalContent.slice(galeriaContentEnd);

            try {
                const writable = await indexFileHandle.createWritable();
                await writable.write(novoConteudoCompleto);
                await writable.close();
                originalContent = novoConteudoCompleto;
                mostrarNotificacao("üíæ Nova ordem salva com sucesso no index.html!");

            } catch (err) {
                console.error("Erro ao salvar o arquivo:", err);
                mostrarNotificacao("‚ùå Erro ao salvar o index.html. Verifique permiss√µes.", false);
            }
        }

        // --- Drag and Drop Logic ---

        function addDragListeners() {
            cardList.querySelectorAll('.card-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index); 
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.card-item').forEach(item => item.style.borderTop = '');
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            const target = e.currentTarget;
            if (target !== draggedItem) {
                target.style.borderTop = '3px solid #007bff';
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.style.borderTop = '';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation(); 
            e.currentTarget.style.borderTop = '';

            const sourceIndex = parseInt(draggedItem.dataset.index);
            const targetIndex = parseInt(e.currentTarget.dataset.index);

            if (sourceIndex !== targetIndex) {
                // Remove o card HTML da posi√ß√£o de origem
                const [movedCard] = extractedCards.splice(sourceIndex, 1);
                // Insere o card HTML na nova posi√ß√£o
                extractedCards.splice(targetIndex, 0, movedCard);

                // Re-renderiza a lista para refletir a nova ordem
                renderCardList();
                mostrarNotificacao(`Ordem alterada! Salve para aplicar no arquivo.`, true);
            }
        }


        carregarIndexBtn.addEventListener('click', carregarIndexHtml);
        salvarAlteracoesBtn.addEventListener('click', salvarAlteracoes);
    </script>
</body>
</html>
