<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Mockup de Canecas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        body { background: #0d0d0d; color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; color: #ff6600; }
        .container { background: #181818; padding: 2rem; border-radius: 1rem; width: 100%; max-width: 800px; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        .input-group { margin-bottom: 1.5rem; }
        label { font-size: 0.95rem; color: #ccc; display: block; margin-bottom: 0.3rem; }
        input[type="file"] { padding: 0.7rem; background: #0f0f0f; border-radius: 6px; border: 1px solid #333; }
        button { background: linear-gradient(90deg, #ff6600, #cc5200); color: #fff; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; margin-top: 10px; }
        button:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(255, 102, 0, 0.6); }

        #mockupCanvas { border: 2px solid #333; display: block; margin: 20px auto; max-width: 100%; }
        #resultadoLink { margin-top: 1.5rem; text-align: center; }
        #resultadoLink a { color: #25D366; text-decoration: none; word-break: break-all; }

        .notificacao { position: fixed; bottom: 30px; right: 30px; background: #25D366; color: #000; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; box-shadow: 0 0 20px rgba(37, 211, 102, 0.6); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 999; }
        .notificacao.mostrar { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <h1>Gerador de Mockup de Canecas ☕</h1>

    <div class="container">
        <p style="color: #f0c000; margin-bottom: 15px;">A imagem base de duas canecas foi carregada automaticamente.</p>

        <div class="input-group">
            <label for="designFile">1. Selecione a ARTE (Estampa) para aplicar:</label>
            <input type="file" id="designFile" accept="image/*">
        </div>

        <button id="gerarMockupBtn">2. Gerar Mockup na Tela</button>
        <button id="uploadMockupBtn" style="display: none; background: #007bff;">3. Enviar Mockup Final para ImgBB</button>

        <canvas id="mockupCanvas" style="display: none;"></canvas>

        <div id="resultadoLink" style="display: none;">
            <p style="color: #25D366; font-weight: bold;">✅ Link ImgBB do Mockup Final:</p>
            <a id="imgbbLink" href="#" target="_blank"></a>
        </div>
    </div>

    <div id="notificacao" class="notificacao"></div>

    <script>
        // ------------------------------------------------------------------
        // CONFIGURAÇÕES NECESSÁRIAS
        // ------------------------------------------------------------------
        const API_KEY_IMG_BB = "bb49178e11dff4322b7a699167535e57"; 
        
        // URL da imagem de template fornecida pelo usuário
        const MUG_TEMPLATE_URL = "https://i.ibb.co/hK5XjT0/mug-template-user.jpg"; 

        // ------------------------------------------------------------------
        // COORDENADAS AJUSTADAS PARA A IMAGEM FORNECIDA
        // [X_inicial, Y_inicial, Largura_final, Altura_final, Opacidade]
        // ------------------------------------------------------------------
        const MUG_MAPPING = [
            // Caneca 1 (Alça para Esquerda - área de estampa visível na direita do objeto)
            // Ajustado para a imagem: X, Y, Largura, Altura
            { x: 340, y: 350, w: 250, h: 250, opacity: 0.95 }, 
            // Caneca 2 (Alça para Direita - área de estampa visível na esquerda do objeto)
            // Ajustado para a imagem: X, Y, Largura, Altura
            { x: 910, y: 350, w: 250, h: 250, opacity: 0.95 }
        ];
        // ------------------------------------------------------------------


        const canvas = document.getElementById('mockupCanvas');
        const ctx = canvas.getContext('2d');
        const designFile = document.getElementById('designFile');
        const gerarMockupBtn = document.getElementById('gerarMockupBtn');
        const uploadMockupBtn = document.getElementById('uploadMockupBtn');

        let templateImage = new Image();
        let designImage = new Image();

        function mostrarNotificacao(mensagem, sucesso = true) {
            const notificacao = document.getElementById('notificacao');
            notificacao.textContent = mensagem;
            notificacao.style.background = sucesso ? '#25D366' : '#dc3545';
            notificacao.classList.add('mostrar');
            setTimeout(() => notificacao.classList.remove('mostrar'), 3000);
        }

        // 1. Carregar o Template Base
        templateImage.onload = function() {
            canvas.width = templateImage.width;
            canvas.height = templateImage.height;
            // Oculta o canvas até a geração
            document.getElementById('mockupCanvas').style.display = 'none';
            // Mensagem de status
            mostrarNotificacao("✅ Imagem base de canecas carregada.", true);
        };
        templateImage.onerror = function() {
            mostrarNotificacao("❌ Erro ao carregar a imagem de template. Verifique a URL.", false);
        }
        templateImage.crossOrigin = "anonymous"; // Necessário para imagens externas no canvas
        templateImage.src = MUG_TEMPLATE_URL;


        // 2. Lógica de Geração do Mockup
        function gerarMockup() {
            if (!designFile.files[0]) {
                mostrarNotificacao("❌ Por favor, selecione um arquivo de arte para estampar.", false);
                return;
            }
            if (!templateImage.complete || templateImage.naturalHeight === 0) {
                mostrarNotificacao("❌ A imagem base das canecas ainda não carregou. Tente novamente em alguns segundos.", false);
                return;
            }

            mostrarNotificacao("Gerando o mockup...", true);
            
            // Cria um URL temporário para a arte carregada
            const reader = new FileReader();
            reader.onload = function(e) {
                designImage.onload = function() {
                    // Limpa e desenha o template
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);

                    // Desenha a arte em cada caneca com as coordenadas definidas
                    MUG_MAPPING.forEach((map, index) => {
                        // Salva o estado atual (para restaurar a opacidade e outras configs)
                        ctx.save(); 
                        
                        // Aplica opacidade para simular a tinta na caneca
                        ctx.globalAlpha = map.opacity || 0.95; 
                        
                        // Desenha a arte na posição e tamanho definidos no MUG_MAPPING
                        ctx.drawImage(designImage, map.x, map.y, map.w, map.h);

                        // Restaura o estado original do canvas
                        ctx.restore(); 
                    });

                    // Mostra o resultado
                    document.getElementById('mockupCanvas').style.display = 'block';
                    uploadMockupBtn.style.display = 'inline-block';
                    mostrarNotificacao("✅ Mockup gerado com sucesso! Agora você pode fazer o upload.", true);
                };
                designImage.src = e.target.result;
            };
            reader.readAsDataURL(designFile.files[0]);
        }
        
        // 3. Lógica de Upload do Mockup Final para ImgBB
        async function uploadMockup() {
            if (API_KEY_IMG_BB === "SUA_CHAVE_API_AQUI") {
                mostrarNotificacao("ERRO: Configure a Chave de API do ImgBB.", false);
                return;
            }

            mostrarNotificacao("Enviando Mockup final para ImgBB...", true);
            uploadMockupBtn.disabled = true;

            // Converte o Canvas em um Blob (formato de arquivo)
            canvas.toBlob(async function(blob) {
                const formData = new FormData();
                formData.append("image", blob, "mockup_final.png");
                formData.append("key", API_KEY_IMG_BB);

                try {
                    const response = await fetch("https://api.imgbb.com/1/upload", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (result.success) {
                        const imageUrl = result.data.display_url;
                        const linkEl = document.getElementById('imgbbLink');
                        linkEl.href = imageUrl;
                        linkEl.textContent = imageUrl;
                        document.getElementById('resultadoLink').style.display = 'block';
                        mostrarNotificacao("✅ Upload concluído! O link está abaixo.", true);
                    } else {
                        throw new Error(result.error.message || "Erro desconhecido no upload.");
                    }
                } catch (error) {
                    console.error("Erro no upload do ImgBB:", error);
                    mostrarNotificacao(`❌ Erro no upload: ${error.message}`, false);
                } finally {
                    uploadMockupBtn.disabled = false;
                }
            }, 'image/png');
        }

        gerarMockupBtn.addEventListener('click', gerarMockup);
        uploadMockupBtn.addEventListener('click', uploadMockup);
    </script>
</body>
</html>
