<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Cards da Galeria</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        body {
            background: #0d0d0d; color: #fff; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; padding: 2rem;
        }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; color: #f0c000; }
        .container {
            background: #181818; padding: 2rem; border-radius: 1rem;
            width: 100%; max-width: 800px; box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        button {
            background: linear-gradient(90deg, #f0c000, #d4a700);
            color: #000; border: none; padding: 0.7rem 1.2rem;
            border-radius: 6px; cursor: pointer; font-size: 1rem;
            font-weight: bold; transition: all 0.3s ease; margin: 0.5rem 0;
        }
        button:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(240, 192, 0, 0.6); }

        /* Lista de Cards */
        #cardList {
            list-style: none;
            margin-top: 1.5rem;
            border-top: 1px solid #333;
            padding-top: 1rem;
        }
        .card-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #222;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        /* NOVO: Estilo para a imagem na lista */
        .card-preview-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            border: 1px solid #444;
        }

        .card-info {
            flex-grow: 1;
            /* Adiciona flex para alinhar texto ao lado da imagem */
            display: flex; 
            align-items: center;
        }
        .card-details {
             /* Wrapper para Nome/ID/Categoria */
            margin-left: 15px; 
        }

        .card-info h3 {
            font-size: 1.1rem;
            color: #f0c000;
        }
        .card-info p {
            font-size: 0.85rem;
            color: #ccc;
        }
        .card-actions {
            flex-shrink: 0; /* Impede que os botões diminuam */
        }
        .card-actions button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        .edit-btn { background: #007bff; color: #fff; }
        .delete-btn { background: #dc3545; color: #fff; }

        /* Modal de Edição (Sem alterações significativas aqui) */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #181818; margin: 5% auto; padding: 20px;
            border: 1px solid #444; width: 90%; max-width: 600px; border-radius: 10px;
            position: relative;
        }
        .close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            position: absolute; top: 10px; right: 20px; cursor: pointer;
        }
        .close:hover { color: #fff; }
        
        .modal-content label { margin-top: 0.8rem; }
        .modal-content input, .modal-content textarea {
            width: 100%; padding: 0.7rem; border-radius: 6px; border: 1px solid #333;
            background: #0f0f0f; color: #fff; font-size: 0.95rem; margin-bottom: 10px;
        }
        .modal-footer {
            margin-top: 1rem;
            text-align: right;
        }
        .modal-footer button {
            background: #25D366; 
            color: #000;
            margin-left: 10px;
        }
        
        /* Estilos para Modelos Dinâmicos */
        #modelosContainer {
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed #444;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .modelo-item-edit {
            background: #282828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .modelo-item-edit h4 {
            color: #f0c000;
            margin-bottom: 5px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .modelo-item-edit input {
            margin-bottom: 5px;
        }
        .modelo-item-edit label {
            margin-top: 0.5rem;
            display: block;
        }

        /* Notificação */
        .notificacao {
            position: fixed; bottom: 30px; right: 30px; background: #25D366;
            color: #000; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600;
            box-shadow: 0 0 20px rgba(37, 211, 102, 0.6); opacity: 0;
            transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 999;
        }
        .notificacao.mostrar {
            opacity: 1; transform: translateY(0);
        }
    </style>
</head>
<body>
    <h1>Editor de Cards da Galeria ✏️</h1>

    <div class="container">
        <button id="carregarIndexBtn">1. Selecionar/Carregar index.html</button>

        <ul id="cardList">
            </ul>
        
        <p id="status" style="color: #f0c000; margin-top: 1rem;">Aguardando o carregamento do arquivo...</p>

        <button id="salvarAlteracoesBtn" style="display:none; background: #25D366; color: #000;">2. Salvar Alterações no index.html</button>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h3>Editar Card</h3>
            <form id="editForm">
                <input type="hidden" id="editCardIndex">
                
                <label for="editNome">Nome da Caneca:</label>
                <input type="text" id="editNome" required>
                
                <label for="editId">ID do Produto:</label>
                <input type="text" id="editId" required>

                <label for="editDescricao">Descrição (Specs):</label>
                <textarea id="editDescricao" rows="3" required></textarea>

                <label>Modelos e Opções:</label>
                <div id="modelosContainer">
                    </div>
                
                <div class="modal-footer">
                    <button type="button" id="cancelEditBtn">Cancelar</button>
                    <button type="submit">Salvar Edição</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notificacao" class="notificacao"></div>

    <script>
        // Variáveis globais para armazenar o FileHandle, Conteúdo Original e Cards
        let indexFileHandle = null;
        let originalContent = '';
        let extractedCards = [];
        let galeriaContentStart = -1;
        let galeriaContentEnd = -1;

        const cardList = document.getElementById('cardList');
        const statusEl = document.getElementById('status');
        const salvarAlteracoesBtn = document.getElementById('salvarAlteracoesBtn');
        const carregarIndexBtn = document.getElementById('carregarIndexBtn');
        
        // Elementos do Modal
        const editModal = document.getElementById('editModal');
        const closeModal = document.getElementById('closeModal');
        const editForm = document.getElementById('editForm');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const modelosContainer = document.getElementById('modelosContainer');

        function mostrarNotificacao(mensagem, sucesso = true) {
            const notificacao = document.getElementById('notificacao');
            notificacao.textContent = mensagem;
            notificacao.style.background = sucesso ? '#25D366' : '#dc3545';
            notificacao.classList.add('mostrar');
            setTimeout(() => notificacao.classList.remove('mostrar'), 3000);
        }

        // Função para extrair cards da string HTML
        function extrairCards(htmlContent) {
            const galeriaSectionRegex = /<section class="galeria">([\s\S]*?)<\/section>/;
            const match = htmlContent.match(galeriaSectionRegex);

            if (!match) {
                mostrarNotificacao("❌ Não foi possível encontrar a <section class='galeria'> no arquivo.", false);
                return [];
            }

            const galeriaContent = match[1];
            
            const galeriaStart = htmlContent.indexOf('<section class="galeria">');
            galeriaContentStart = galeriaStart + '<section class="galeria">'.length;
            galeriaContentEnd = galeriaContentStart + galeriaContent.length;

            const cardRegex = /(<div\s+class="item"[\s\S]*?<\/div>\s*<\/div>)/g;
            const cardMatches = [...galeriaContent.matchAll(cardRegex)];

            return cardMatches.map(m => m[0].trim());
        }

        // Função para parsear e extrair dados de um card (string HTML)
        function parseCardData(cardHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHtml;
            const card = tempDiv.querySelector('.item');
            if (!card) return null;

            const button = card.querySelector('button.open-modal-btn');
            const img = card.querySelector('img');
            
            const specs = button.getAttribute('data-specs');
            const options = button.getAttribute('data-options');

            return {
                html: cardHtml,
                categoria: card.getAttribute('data-categoria'),
                nome: button.getAttribute('data-name'),
                id: button.getAttribute('data-id'),
                image: img ? img.src : '', // Captura a URL da imagem principal
                specs: specs,
                options: options // JSON string
            };
        }

        // Função principal para listar os cards
        function renderCardList() {
            cardList.innerHTML = '';
            if (extractedCards.length === 0) {
                statusEl.textContent = "Nenhum card encontrado na galeria.";
                salvarAlteracoesBtn.style.display = 'none';
                return;
            }

            statusEl.textContent = `Total de ${extractedCards.length} cards encontrados.`;

            extractedCards.forEach((cardHtml, index) => {
                const cardData = parseCardData(cardHtml);
                if (!cardData) return;

                const listItem = document.createElement('li');
                listItem.className = 'card-item';
                listItem.innerHTML = `
                    <div class="card-info">
                        <img src="${cardData.image}" alt="${cardData.nome}" class="card-preview-img">
                        <div class="card-details">
                            <h3>${cardData.nome} (ID: ${cardData.id})</h3>
                            <p>Categoria: ${cardData.categoria}</p>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="edit-btn" data-index="${index}">Editar</button>
                        <button class="delete-btn" data-index="${index}">Excluir</button>
                    </div>
                `;
                cardList.appendChild(listItem);
            });

            // Adicionar listeners para os botões de ação
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openEditModal(parseInt(e.target.dataset.index)));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => excluirCard(parseInt(e.target.dataset.index)));
            });

            salvarAlteracoesBtn.style.display = 'block';
        }

        // ------------------------
        // Funções de Ação
        // ------------------------

        async function carregarIndexHtml() {
            try {
                const [handle] = await window.showOpenFilePicker({
                    types: [{ description: "HTML Files (index.html)", accept: { "text/html": [".html"] } }],
                    multiple: false
                });
                indexFileHandle = handle;
                statusEl.textContent = "Lendo arquivo...";
                
                const file = await indexFileHandle.getFile();
                originalContent = await file.text();

                extractedCards = extrairCards(originalContent);
                renderCardList();
                mostrarNotificacao("✅ index.html carregado com sucesso!");

            } catch (err) {
                console.error("Erro ao carregar ou ação cancelada:", err);
                statusEl.textContent = "Aguardando o carregamento do arquivo...";
                mostrarNotificacao("⚠️ Ação cancelada ou erro ao carregar o arquivo.", false);
            }
        }
        
        function openEditModal(index) {
            const cardData = parseCardData(extractedCards[index]);
            if (!cardData) return;

            // 1. Preenche os campos de Nome, ID, e Descrição
            document.getElementById('editCardIndex').value = index;
            document.getElementById('editNome').value = cardData.nome;
            document.getElementById('editId').value = cardData.id;
            document.getElementById('editDescricao').value = cardData.specs;
            
            // 2. Preenche os campos dinâmicos de Modelos/Opções
            modelosContainer.innerHTML = '';
            
            let optionsArray;
            try {
                optionsArray = JSON.parse(cardData.options);
            } catch (e) {
                mostrarNotificacao("❌ Erro ao parsear JSON das Opções/Modelos do card.", false);
                return;
            }

            optionsArray.forEach((option, modelIndex) => {
                const div = document.createElement('div');
                div.className = 'modelo-item-edit';
                div.innerHTML = `
                    <h4>Modelo: ${option.model}</h4>
                    
                    <label for="modelPrice_${modelIndex}">Preço (R$):</label>
                    <input type="number" step="0.01" id="modelPrice_${modelIndex}" data-model-index="${modelIndex}" value="${option.price.toFixed(2)}" required>
                    
                    <label for="modelImage_${modelIndex}">Link da Imagem:</label>
                    <input type="url" id="modelImage_${modelIndex}" data-model-index="${modelIndex}" value="${option.image}" required>
                `;
                modelosContainer.appendChild(div);
            });

            editModal.style.display = 'block';
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const index = parseInt(document.getElementById('editCardIndex').value);
            
            const novoNome = document.getElementById('editNome').value.trim();
            const novoId = document.getElementById('editId').value.trim();
            const novaDescricao = document.getElementById('editDescricao').value.trim();
            
            // --- Reconstruir o optionsArray a partir dos campos dinâmicos ---
            const oldCardData = parseCardData(extractedCards[index]);
            let oldOptionsArray = JSON.parse(oldCardData.options);

            const novoOptionsArray = oldOptionsArray.map((oldOption, modelIndex) => {
                const newPriceInput = document.getElementById(`modelPrice_${modelIndex}`);
                const newImageInput = document.getElementById(`modelImage_${modelIndex}`);
                
                if (!newPriceInput || !newImageInput || !newPriceInput.value || !newImageInput.value) {
                    mostrarNotificacao("❌ Preços e links das imagens não podem estar vazios.", false);
                    throw new Error("Missing model data. Stopping form submission.");
                }
                
                return {
                    model: oldOption.model, 
                    price: parseFloat(newPriceInput.value),
                    image: newImageInput.value.trim()
                };
            });
            
            // Reconstrução do card HTML
            const primeiraImagem = novoOptionsArray[0].image; // Usa a primeira imagem do novo array
            const precoExibido = novoOptionsArray[0].price.toFixed(2).replace('.', ',');
            const categoria = oldCardData.categoria;

            const novoCardHtml = `
<div class="item" data-categoria="${categoria}">
  <img src="${primeiraImagem}" alt="${novoNome}">
  <div class="info">
    <h2>${novoNome}</h2>
    <p>ID: ${novoId}</p>
    <p>R$ ${precoExibido}</p>
    <button class="open-modal-btn"
      data-name="${novoNome}"
      data-id="${novoId}"
      data-image="${primeiraImagem}"
      data-specs="${novaDescricao}"
      data-options='${JSON.stringify(novoOptionsArray)}'>
      Ver Detalhes
    </button>
  </div>
</div>`.trim();

            // Substitui o card antigo pelo novo e atualiza a lista
            extractedCards[index] = novoCardHtml;
            renderCardList();
            closeEditModal();
            mostrarNotificacao(`✅ Card "${novoNome}" editado com sucesso (Aguardando Salvar).`);
        });

        function excluirCard(index) {
            const cardData = parseCardData(extractedCards[index]);
            if (confirm(`Tem certeza que deseja EXCLUIR o card: "${cardData.nome}" (ID: ${cardData.id})?`)) {
                extractedCards.splice(index, 1);
                renderCardList();
                mostrarNotificacao(`🗑️ Card "${cardData.nome}" excluído (Aguardando Salvar).`);
            }
        }

        async function salvarAlteracoes() {
            if (!indexFileHandle) {
                mostrarNotificacao("❌ Nenhum arquivo carregado.", false);
                return;
            }

            // 1. Constrói o novo conteúdo da galeria
            const novoConteudoGaleria = "\n" + extractedCards.join("\n") + "\n";
            
            // 2. Constrói o novo conteúdo completo do index.html
            const novoConteudoCompleto = 
                originalContent.slice(0, galeriaContentStart) +
                novoConteudoGaleria +
                originalContent.slice(galeriaContentEnd);

            try {
                // 3. Escreve no arquivo via File System Access API
                const writable = await indexFileHandle.createWritable();
                await writable.write(novoConteudoCompleto);
                await writable.close();
                
                // Atualiza o conteúdo original para permitir novas edições sem recarregar
                originalContent = novoConteudoCompleto;
                
                mostrarNotificacao("💾 Todas as alterações foram salvas com sucesso no index.html!");

            } catch (err) {
                console.error("Erro ao salvar o arquivo:", err);
                mostrarNotificacao("❌ Erro ao salvar o index.html. Verifique permissões.", false);
            }
        }

        // ------------------------
        // Event Listeners
        // ------------------------
        carregarIndexBtn.addEventListener('click', carregarIndexHtml);
        salvarAlteracoesBtn.addEventListener('click', salvarAlteracoes);
        closeModal.addEventListener('click', closeEditModal);
        cancelEditBtn.addEventListener('click', closeEditModal);
        window.addEventListener('click', (event) => {
            if (event.target === editModal) {
                closeEditModal();
            }
        });
        
    </script>
</body>
</html>
